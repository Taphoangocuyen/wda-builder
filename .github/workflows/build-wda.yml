name: Build iPhoneControl WDA for TrollStore

on:
  workflow_dispatch:
    inputs:
      bundle_id:
        description: 'Bundle ID for WDA'
        required: false
        default: 'com.facebook.WebDriverAgentRunner'
      display_name:
        description: 'App display name'
        required: false
        default: 'iPhone Control'
      ipa_filename:
        description: 'Output IPA filename (without .ipa)'
        required: false
        default: 'iPhoneControl'
      auth_key:
        description: 'IPC Auth Key (leave empty to use repository secret IPC_AUTH_KEY)'
        required: false
        default: ''
      min_ios_version:
        description: 'Minimum iOS version'
        required: false
        default: '15.0'
      wda_version:
        description: 'WDA version (tag, branch, or commit SHA). Leave empty for latest.'
        required: false
        default: ''

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 0: Clone WDA vá»›i version pinning
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Clone WebDriverAgent source
        run: |
          git clone https://github.com/appium/WebDriverAgent.git
          cd WebDriverAgent

          WDA_VERSION="${{ github.event.inputs.wda_version }}"
          if [ -n "$WDA_VERSION" ]; then
            echo "ğŸ“Œ Checking out WDA version: $WDA_VERSION"
            git checkout "$WDA_VERSION"
          fi

          WDA_TAG=$(git describe --tags --always 2>/dev/null || echo "unknown")
          WDA_COMMIT=$(git rev-parse --short HEAD)
          echo "WDA version: $WDA_TAG (commit: $WDA_COMMIT)"
          echo "WDA_TAG=$WDA_TAG" >> $GITHUB_ENV
          echo "WDA_COMMIT=$WDA_COMMIT" >> $GITHUB_ENV

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 0.5: Install ldid (khÃ´ng cache â€” trÃ¡nh lá»—i dependency)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Install ldid
        run: brew install ldid

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 1: Customize WDA (permissions, MinimumOSVersion...)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Customize WDA pre-build
        run: |
          export DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          export BUNDLE_PREFIX="com.facebook"
          export MIN_IOS="${{ github.event.inputs.min_ios_version }}"
          bash scripts/customize_wda.sh

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 2: Patch auth â€” Layer 1 (inject vÃ o RoutingConnection.m)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Patch WDA with auth guard (Layer 1 â€” source patch)
        env:
          INPUT_AUTH_KEY: ${{ github.event.inputs.auth_key }}
          SECRET_AUTH_KEY: ${{ secrets.IPC_AUTH_KEY }}
        run: |
          set -euo pipefail

          # â”€â”€ Debug: kiá»ƒm tra nguá»“n auth key â”€â”€
          echo "=== Auth Key Debug ==="
          echo "  Input auth_key length: ${#INPUT_AUTH_KEY}"
          echo "  Secret IPC_AUTH_KEY length: ${#SECRET_AUTH_KEY}"

          # Æ¯u tiÃªn: input > secret
          AUTH_KEY="$INPUT_AUTH_KEY"
          if [ -z "$AUTH_KEY" ]; then
            echo "  Input trá»‘ng â†’ dÃ¹ng repository secret"
            AUTH_KEY="$SECRET_AUTH_KEY"
          else
            echo "  DÃ¹ng auth key tá»« workflow input"
          fi

          echo "  Final AUTH_KEY length: ${#AUTH_KEY}"

          if [ -z "$AUTH_KEY" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  FATAL: KhÃ´ng cÃ³ auth key!                          â•‘"
            echo "â•‘                                                      â•‘"
            echo "â•‘  Kiá»ƒm tra: Settings â†’ Secrets â†’ Actions             â•‘"
            echo "â•‘  Secret name: IPC_AUTH_KEY                           â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi

          if [ ${#AUTH_KEY} -lt 16 ]; then
            echo "FATAL: Auth key quÃ¡ ngáº¯n (${#AUTH_KEY} chars). Tá»‘i thiá»ƒu 16 chars!"
            exit 1
          fi

          ROUTE_PREFIX="ipc_${AUTH_KEY:0:8}"
          echo "  Auth key: ${#AUTH_KEY} chars, prefix: $ROUTE_PREFIX"

          echo "AUTH_ENABLED=true" >> $GITHUB_ENV
          {
            echo "AUTH_KEY<<AUTHEOF"
            echo "$AUTH_KEY"
            echo "AUTHEOF"
          } >> $GITHUB_ENV
          echo "ROUTE_PREFIX=$ROUTE_PREFIX" >> $GITHUB_ENV

          python3 scripts/patch_auth.py WebDriverAgent "$AUTH_KEY" "$ROUTE_PREFIX"
          echo "  âœ… Layer 1 patched"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 3: Auth guard â€” Layer 2 (IPCAuthGuard.m swizzle backup)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Add IPCAuthGuard.m to Xcode project (Layer 2 â€” swizzle backup)
        if: env.AUTH_ENABLED == 'true'
        run: |
          set -euo pipefail
          echo "=== Adding IPCAuthGuard.m (double-layer auth) ==="

          # TÃ¬m thÆ° má»¥c Routing trong WDA source
          ROUTING_DIR=$(find WebDriverAgent -type d -name "Routing" | head -1)
          if [ -z "$ROUTING_DIR" ]; then
            # Fallback: thÃªm vÃ o WebDriverAgentLib root
            ROUTING_DIR="WebDriverAgent/WebDriverAgentLib/WebDriverAgentLib"
            echo "  Routing dir not found, using: $ROUTING_DIR"
          fi

          # Copy IPCAuthGuard.m vÃ o WDA source
          cp src/IPCAuthGuard.m "$ROUTING_DIR/"
          echo "  Copied to: $ROUTING_DIR/IPCAuthGuard.m"

          # Replace placeholders vá»›i actual keys
          sed -i '' "s|__IPC_AUTH_KEY__|$AUTH_KEY|g" "$ROUTING_DIR/IPCAuthGuard.m"
          sed -i '' "s|__IPC_ROUTE_PREFIX__|$ROUTE_PREFIX|g" "$ROUTING_DIR/IPCAuthGuard.m"

          # Verify placeholders Ä‘Ã£ Ä‘Æ°á»£c thay tháº¿
          if grep -q "__IPC_AUTH_KEY__" "$ROUTING_DIR/IPCAuthGuard.m"; then
            echo "FATAL: Placeholder __IPC_AUTH_KEY__ chÆ°a Ä‘Æ°á»£c thay tháº¿!"
            exit 1
          fi
          echo "  âœ… Placeholders verified"

          # ThÃªm vÃ o Xcode project
          gem install xcodeproj
          ruby scripts/add_to_xcode.rb
          echo "  âœ… IPCAuthGuard.m added to Xcode project"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 4: Build
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Build WebDriverAgent for iOS (arm64)
        run: |
          cd WebDriverAgent

          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="${{ github.event.inputs.bundle_id }}" \
            DEVELOPMENT_TEAM="" \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=NO \
            IPHONEOS_DEPLOYMENT_TARGET="${{ github.event.inputs.min_ios_version }}"

          echo "=== Build completed ==="

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 5: Package TrollStore-compatible IPA
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Package TrollStore-compatible IPA
        run: |
          set -euo pipefail

          BUNDLE_ID="${{ github.event.inputs.bundle_id }}"
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          MIN_IOS="${{ github.event.inputs.min_ios_version }}"
          IPA_NAME="${{ github.event.inputs.ipa_filename }}"

          # â”€â”€ TÃ¬m .app Ä‘Ã£ build â”€â”€
          APP_PATH=$(find WebDriverAgent/build -name "WebDriverAgentRunner-Runner.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          if [ -z "$APP_PATH" ]; then
            echo "ERROR: WebDriverAgentRunner-Runner.app not found!"
            find WebDriverAgent/build -name "*.app" -type d
            exit 1
          fi

          # â”€â”€ Táº¡o Payload â”€â”€
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          TARGET_APP="Payload/WebDriverAgentRunner-Runner.app"
          PLIST="$TARGET_APP/Info.plist"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Strip Testing.framework (khÃ´ng cáº§n, tiáº¿t kiá»‡m ~5MB)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ -d "$TARGET_APP/Frameworks/Testing.framework" ]; then
            TESTING_SIZE=$(du -sh "$TARGET_APP/Frameworks/Testing.framework" | cut -f1)
            rm -rf "$TARGET_APP/Frameworks/Testing.framework"
            echo "âœ… ÄÃ£ xÃ³a Testing.framework ($TESTING_SIZE) â€” WDA khÃ´ng sá»­ dá»¥ng"
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Custom App Icon (chá»‰ resize, KHÃ”NG copy gá»‘c 1.1MB)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ -f "resources/icon.png" ]; then
            echo "=== Setting custom app icon (optimized) ==="
            sips -z 120 120 resources/icon.png --out "$TARGET_APP/AppIcon60x60@2x.png" || true
            sips -z 180 180 resources/icon.png --out "$TARGET_APP/AppIcon60x60@3x.png" || true
            sips -z 152 152 resources/icon.png --out "$TARGET_APP/AppIcon76x76@2x.png" || true
            sips -z 167 167 resources/icon.png --out "$TARGET_APP/AppIcon83.5x83.5@2x.png" || true

            /usr/libexec/PlistBuddy -c "Delete :CFBundleIcons" "$PLIST" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleIcons dict" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon dict" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles array" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles:0 string AppIcon60x60" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles:1 string AppIcon76x76" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles:2 string AppIcon83.5x83.5" "$PLIST"
            echo "  âœ… App icon set (optimized, no raw copy)"
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Patch Info.plist â€” Bundle ID + Display Name
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName '$DISPLAY_NAME'" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string '$DISPLAY_NAME'" "$PLIST"

          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier '${BUNDLE_ID}.xctrunner'" "$PLIST"

          XCTEST_DIR=$(find "$TARGET_APP/PlugIns" -name "*.xctest" -type d | head -1)
          if [ -n "$XCTEST_DIR" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier '$BUNDLE_ID'" "$XCTEST_DIR/Info.plist" 2>/dev/null || true
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # TrollStore self-launch config
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "=== Configuring for TrollStore ==="

          # MinimumOSVersion
          /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion '$MIN_IOS'" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string '$MIN_IOS'" "$PLIST"

          # Self-launch
          /usr/libexec/PlistBuddy -c "Set :SBIsLaunchableDuringSetup true" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :SBIsLaunchableDuringSetup bool true" "$PLIST"

          /usr/libexec/PlistBuddy -c "Set :UIRequiresFullScreen true" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :UIRequiresFullScreen bool true" "$PLIST"

          # Background mode
          /usr/libexec/PlistBuddy -c "Delete :UIBackgroundModes" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :UIBackgroundModes array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :UIBackgroundModes:0 string continuous" "$PLIST"

          # iPhone + iPad
          /usr/libexec/PlistBuddy -c "Delete :UIDeviceFamily" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :UIDeviceFamily array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :UIDeviceFamily:0 integer 1" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :UIDeviceFamily:1 integer 2" "$PLIST"

          # HTTP cho local network
          /usr/libexec/PlistBuddy -c "Delete :NSAppTransportSecurity" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity:NSAllowsArbitraryLoads bool true" "$PLIST"

          # Bonjour services (cáº§n cho iOS 14+ local network)
          /usr/libexec/PlistBuddy -c "Delete :NSBonjourServices" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :NSBonjourServices array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :NSBonjourServices:0 string _http._tcp" "$PLIST"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # XÃ³a permissions thá»«a tá»« WDA máº·c Ä‘á»‹nh (post-build)
          # Giá»¯ láº¡i chá»‰ 6 permissions thiáº¿t yáº¿u
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "=== Cleaning unnecessary permissions ==="
          removed=0
          for perm in \
            NFCReaderUsageDescription \
            NSAppleMusicUsageDescription \
            NSBluetoothAlwaysUsageDescription \
            NSBluetoothPeripheralUsageDescription \
            NSCalendarsUsageDescription \
            NSContactsUsageDescription \
            NSFaceIDUsageDescription \
            NSHealthClinicalHealthRecordsShareUsageDescription \
            NSHealthShareUsageDescription \
            NSHealthUpdateUsageDescription \
            NSHomeKitUsageDescription \
            NSLocationDefaultAccuracyReduced \
            NSMotionUsageDescription \
            NSRemindersUsageDescription \
            NSSensorKitPrivacyPolicyURL \
            NSSensorKitUsageDescription \
            NSSensorKitUsageDetail \
            NSSiriUsageDescription \
            NSSpeechRecognitionUsageDescription \
            NSUserTrackingUsageDescription \
            NSVideoSubscriberAccountUsageDescription; do
            if /usr/libexec/PlistBuddy -c "Delete :$perm" "$PLIST" 2>/dev/null; then
              ((removed++))
            fi
          done
          echo "  âœ… ÄÃ£ xÃ³a $removed permissions thá»«a tá»« IPA"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ThÃªm/Ä‘áº£m báº£o 6 permissions thiáº¿t yáº¿u
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PERM_TEXT="Required for device automation"
          for perm in \
            NSLocalNetworkUsageDescription \
            NSCameraUsageDescription \
            NSPhotoLibraryUsageDescription \
            NSMicrophoneUsageDescription \
            NSLocationWhenInUseUsageDescription \
            NSLocationAlwaysAndWhenInUseUsageDescription; do
            /usr/libexec/PlistBuddy -c "Set :$perm '$PERM_TEXT'" "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :$perm string '$PERM_TEXT'" "$PLIST"
          done
          echo "  âœ… 6 essential permissions ensured"

          echo "  âœ… TrollStore config applied (MinOS=$MIN_IOS)"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Dá»n dáº¹p signatures cÅ©
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          find Payload -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find Payload -name "embedded.mobileprovision" -delete 2>/dev/null || true
          find Payload -name "*.dSYM" -type d -exec rm -rf {} + 2>/dev/null || true

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Patch MH_BUNDLE â†’ MH_DYLIB (Frameworks ONLY)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "=== Patching Mach-O binaries (Frameworks only) ==="
          python3 << 'PYEOF'
          import struct, os

          def get_macho_info(filepath):
              try:
                  with open(filepath, 'rb') as f:
                      data = f.read(32)
                  if len(data) < 16:
                      return None
                  magic = struct.unpack_from('<I', data, 0)[0]
                  if magic in (0xfeedfacf, 0xfeedface, 0xbebafeca, 0xcafebabe):
                      return magic
                  return None
              except:
                  return None

          def patch_bundle_to_dylib(filepath):
              with open(filepath, 'rb') as f:
                  data = bytearray(f.read())

              magic = struct.unpack_from('<I', data, 0)[0]
              patched = False
              fname = os.path.basename(filepath)

              if magic in (0xfeedfacf, 0xfeedface):
                  ft = struct.unpack_from('<I', data, 12)[0]
                  if ft == 8:
                      struct.pack_into('<I', data, 12, 6)
                      patched = True
                      print(f"  [{fname}] PATCHED: MH_BUNDLE -> MH_DYLIB")

              elif magic in (0xbebafeca, 0xcafebabe):
                  nfat = struct.unpack_from('>I', data, 4)[0]
                  for i in range(nfat):
                      entry_offset = 8 + i * 20
                      slice_offset = struct.unpack_from('>I', data, entry_offset + 8)[0]
                      slice_magic = struct.unpack_from('<I', data, slice_offset)[0]
                      if slice_magic in (0xfeedfacf, 0xfeedface):
                          ft = struct.unpack_from('<I', data, slice_offset + 12)[0]
                          if ft == 8:
                              struct.pack_into('<I', data, slice_offset + 12, 6)
                              patched = True
                              print(f"  [{fname}] Slice {i} PATCHED")

              if patched:
                  with open(filepath, 'wb') as f:
                      f.write(data)
              return patched

          total_patched = 0
          for root, dirs, files in os.walk("Payload"):
              for fname in files:
                  fpath = os.path.join(root, fname)
                  if "/Frameworks/" not in fpath.replace("\\", "/"):
                      continue
                  magic = get_macho_info(fpath)
                  if magic is not None:
                      if patch_bundle_to_dylib(fpath):
                          total_patched += 1

          print(f"\nTotal binaries patched: {total_patched}")
          PYEOF

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Fakesign vá»›i ldid + TrollStore entitlements
          # FIX: dÃ¹ng process substitution thay vÃ¬ pipe
          # Ä‘á»ƒ ldid fail â†’ workflow fail
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "=== Fakesigning binaries with TrollStore entitlements ==="
          ENTITLEMENTS="resources/entitlements.plist"
          if [ ! -f "$ENTITLEMENTS" ]; then
            echo "FATAL: entitlements.plist not found!"
            exit 1
          fi

          SIGN_COUNT=0
          while IFS= read -r -d '' f; do
            if file "$f" | grep -q "Mach-O"; then
              echo "  Signing: $(basename "$f")"
              ldid -S"$ENTITLEMENTS" "$f" || { echo "FATAL: ldid failed on $f"; exit 1; }
              ((SIGN_COUNT++))
            fi
          done < <(find Payload -type f -print0)
          echo "  âœ… Signed $SIGN_COUNT Mach-O binaries"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Auth status log
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ "$AUTH_ENABLED" = "true" ]; then
            echo ""
            echo "ğŸ” Auth: ENABLED (double-layer)"
            echo "  Layer 1: patch_auth.py (source injection)"
            echo "  Layer 2: IPCAuthGuard.m (swizzle backup)"
          else
            echo ""
            echo "âš ï¸ Auth: DISABLED (no auth key provided)"
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Táº¡o IPA
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          zip -r "${IPA_NAME}.ipa" Payload/
          echo ""
          echo "=== âœ… IPA created ==="
          ls -lh "${IPA_NAME}.ipa"

          # LÆ°u tÃªn IPA cho step sau
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BÆ°á»›c 6: Kiá»ƒm tra IPA há»£p lá»‡
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Verify IPA
        run: |
          IPA_NAME="${{ github.event.inputs.ipa_filename }}"
          echo "=== Verifying ${IPA_NAME}.ipa ==="

          # Kiá»ƒm tra file tá»“n táº¡i vÃ  kÃ­ch thÆ°á»›c há»£p lÃ½
          IPA_SIZE=$(stat -f%z "${IPA_NAME}.ipa" 2>/dev/null || stat --format=%s "${IPA_NAME}.ipa")
          IPA_SIZE_MB=$(echo "scale=1; $IPA_SIZE / 1048576" | bc)
          echo "  KÃ­ch thÆ°á»›c: ${IPA_SIZE_MB} MB"

          if [ "$IPA_SIZE" -lt 1000000 ]; then
            echo "ERROR: IPA quÃ¡ nhá» ($IPA_SIZE bytes) â€” cÃ³ thá»ƒ build lá»—i!"
            exit 1
          fi

          # Kiá»ƒm tra cáº¥u trÃºc IPA
          unzip -t "${IPA_NAME}.ipa" > /dev/null 2>&1 || { echo "ERROR: IPA zip bá»‹ há»ng!"; exit 1; }

          # Kiá»ƒm tra binary chÃ­nh tá»“n táº¡i
          unzip -l "${IPA_NAME}.ipa" | grep -q "WebDriverAgentRunner-Runner$" || {
            echo "ERROR: Binary chÃ­nh khÃ´ng tÃ¬m tháº¥y trong IPA!"
            exit 1
          }

          # Kiá»ƒm tra WebDriverAgentLib
          unzip -l "${IPA_NAME}.ipa" | grep -q "WebDriverAgentLib" || {
            echo "ERROR: WebDriverAgentLib khÃ´ng tÃ¬m tháº¥y!"
            exit 1
          }

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Verify auth guard trong binary
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ "${{ env.AUTH_ENABLED }}" = "true" ]; then
            echo "=== Verifying auth guard in binary ==="
            TEMP_VERIFY=$(mktemp -d)
            unzip -q "${IPA_NAME}.ipa" -d "$TEMP_VERIFY"

            AUTH_FOUND=false
            while IFS= read -r -d '' bf; do
              if file "$bf" | grep -q "Mach-O"; then
                if strings "$bf" | grep -q "IPC-Auth\|ipc_\|IPCAuthGuard\|__ipc_blocked__"; then
                  echo "  âœ… Auth strings found in: $(basename "$bf")"
                  AUTH_FOUND=true
                fi
              fi
            done < <(find "$TEMP_VERIFY" -type f -print0)

            rm -rf "$TEMP_VERIFY"

            if [ "$AUTH_FOUND" = "false" ]; then
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  FATAL: Auth guard KHÃ”NG cÃ³ trong binary!            â•‘"
              echo "â•‘  Auth key Ä‘Ã£ set nhÆ°ng khÃ´ng Ä‘Æ°á»£c compile vÃ o WDA.  â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
            fi
          fi

          # Log build info
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     BUILD SUMMARY                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "  IPA: ${IPA_NAME}.ipa (${IPA_SIZE_MB} MB)"
          echo "  Display Name: ${{ github.event.inputs.display_name }}"
          echo "  Bundle ID: ${{ github.event.inputs.bundle_id }}"
          echo "  Min iOS: ${{ github.event.inputs.min_ios_version }}"
          echo "  WDA: ${{ env.WDA_TAG }} (${{ env.WDA_COMMIT }})"
          echo "  Auth: ${{ env.AUTH_ENABLED }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Upload artifact
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.ipa_filename }}-IPA
          path: ${{ github.event.inputs.ipa_filename }}.ipa
          retention-days: 90
